<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="com.llbt.cms.dao.MenuMapper">
	<!-- 查询结果映射 -->
	<resultMap id="searchResultMap" type="com.llbt.cms.entity.Menu">
		<result property="id" column="id" />
		<result property="createBy" column="create_by" />
		<result property="createDate" column="create_date" />
		<result property="updateBy" column="update_by" />
		<result property="updateDate" column="update_date" />
		<result property="parentId" column="parent_id" />
		<result property="menuName" column="menu_name" />
		<result property="menuUrl" column="menu_url" />
		<result property="menuDesc" column="menu_desc" />
		<result property="menuType" column="menu_type" />
		<result property="menuCode" column="menu_code" />
		<result property="isDelete" column="is_delete" />
		<result property="distribution" column="distribution" />
	</resultMap>
	<!-- 用于select查询公用抽取的列 -->
	<sql id="columns" >
		id,create_by,create_date,update_by,update_date,parent_id,menu_name,menu_url,menu_desc,menu_type,menu_code,is_delete
	</sql>
	<!-- 新增记录 -->
	<insert id="insert" parameterType="com.llbt.cms.entity.Menu">
		INSERT INTO mms_menu (
		id ,
		create_by ,
		create_date ,
		update_by ,
		update_date ,
		parent_id ,
		menu_name ,
		menu_url ,
		menu_desc ,
		menu_type ,
		menu_code ,
		is_delete
		) VALUES (
		#{id} ,
		#{createBy} ,
		#{createDate} ,
		#{updateBy} ,
		#{updateDate} ,
		#{parentId} ,
		#{menuName} ,
		#{menuUrl} ,
		#{menuDesc} ,
		#{menuType} ,
		#{menuCode} ,
		#{isDelete}
		)
	</insert>
	<!-- 单记录删除 -->
	<delete id="delete" parameterType="java.lang.String">
		delete from mms_menu where
		id=#{id}
	</delete>
	<!-- 批量记录删除 -->
	<delete id="deleteByIds" parameterType="java.util.List">
		delete from mms_menu where id in
		<foreach collection="list" item="ids" open="(" separator=","
			close=")">#{ids}</foreach>
	</delete>
	<!-- 按条件删除 -->
	<!-- <delete id="deleteBySearchCondition" parameterType="com.llbt.cms.vo.searcher.MenuSC" 
		> DELETE FROM mms_menu <include refid="searchConditionSQL" /> </delete> -->
	<!-- 单记录更新 -->
	<update id="update" parameterType="com.llbt.cms.entity.Menu">
		UPDATE mms_menu
		<trim prefix="set" suffixOverrides=",">
			<if test="updateBy != null">
				update_by =#{updateBy},
			</if>
			<if test="updateDate != null">
				update_date =#{updateDate},
			</if>
			<if test="parentId != null">
				parent_id =#{parentId},
			</if>
			<if test="menuName != null">
				menu_name =#{menuName},
			</if>
			<if test="menuUrl != null">
				menu_url =#{menuUrl},
			</if>
			<if test="menuDesc != null">
				menu_desc =#{menuDesc},
			</if>
			<if test="menuType != null">
				menu_type =#{menuType},
			</if>
			<if test="menuCode != null">
				menu_code =#{menuCode},
			</if>
			<if test="isDelete != null">
				is_delete =#{isDelete},
			</if>
		</trim>
		where id=#{id}
	</update>
	<!-- 查询记录BY ID -->
	<select id="getById" resultMap="searchResultMap" parameterType="java.lang.String">
		select
		<include refid="columns" />
		from
		mms_menu where id=#{id}
	</select>
	<!-- 查询所有记录 -->
	<select id="getAll" resultMap="searchResultMap">
		select
		<include refid="columns" />
		from
		mms_menu where is_delete=0 order by menu_seq asc
	</select>

	<!-- 动态查询条件 -->
	<sql id="searchConditionSQL">
		<trim prefix="where" prefixOverrides="AND |OR ">
			<if test="id != null">
				and id = #{id}
			</if>
			<if test="createBy != null">
				and create_by = #{createBy}
			</if>
			<if test="createDate != null">
				and create_date = #{createDate}
			</if>
			<if test="updateBy != null">
				and update_by = #{updateBy}
			</if>
			<if test="updateDate != null">
				and update_date = #{updateDate}
			</if>
			<if test="parentId != null">
				and parent_id = #{parentId}
			</if>
			<if test="menuName != null">
				and menu_name = #{menuName}
			</if>
			<if test="menuUrl != null">
				and menu_url = #{menuUrl}
			</if>
			<if test="menuDesc != null">
				and menu_desc = #{menuDesc}
			</if>
			<if test="menuType != null">
				and menu_type = #{menuType}
			</if>
			<if test="menuCode != null">
				and menu_code = #{menuCode}
			</if>
			<if test="isDelete != null">
				and is_delete = #{isDelete}
			</if>
		</trim>
	</sql>

	<select id="getMenuList" resultMap="searchResultMap">
		select
		<include refid="columns" />
		from mms_menu where is_delete=0 order by menu_seq ASC
	</select>

	<insert id="addRoleMenus" parameterType="java.util.List">
		<!-- BEGIN -->
			insert into mms_role_menu(role_id,menu_id)
			values
			<foreach collection="menuIds" item="menuId" index="index"
			separator=",">(#{roleId},#{menuId})
		</foreach>
		<!-- ;END -->;
	</insert>

	<delete id="deleteRoleMenus" parameterType="java.util.List">
		delete from
		mms_role_menu where role_id in
		<foreach collection="list" item="ids" open="(" separator=","
			close=")">#{ids}</foreach>
	</delete>

	<select id="getRoleMenusDistri" resultMap="searchResultMap"
		parameterType="java.lang.String">
		select m.*, nvl2(rm.menu_id, '1', '0') distribution
		from
		(select *
		from mms_menu mm, mms_role_menu rmm
		where mm.id = rmm.menu_id
		and rmm.role_id =
		(select parent_id
		from mms_role
		where id = #{id})) m
		left join mms_role_menu rm
		on m.id = rm.menu_id
		and rm.role_id = #{id}
		where m.is_delete = 0
		order by m.menu_seq asc
	</select>

	<select id="getAllRoleMenusDistri" resultMap="searchResultMap"
		parameterType="java.lang.String">
		select m.*, IF (rm.menu_id is null, '0', '1') distribution
		from
		mms_menu m
		left join mms_role_menu rm
		on m.id = rm.menu_id
		and rm.role_id
		= #{id}
		where m.is_delete = 0
		order by m.menu_seq asc
	</select>
</mapper>